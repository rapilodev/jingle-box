<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FRBB DAB+ Jingle-Player</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  height: 100vh;
}
header {
  padding: 10px;
  text-align: center;
  background: #222;
  color: #fff;
}
main {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 10px;
  overflow-y: auto;
}
.category {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  margin-bottom: 10px;
  background: #f4f4f4;
  padding: 8px;
  border-radius: 8px;
  cursor: move;
}
.category.dragging {
  opacity: 0.5;
  border: 2px dashed #333;
}
.category label {
  width: 100px;
  font-weight: bold;
}
.category select {
  flex: 1;
  padding: 6px;
  margin-right: 8px;
  min-width: 150px;
  font-size: 1.1em;
}
.category button {
  padding: 10px 16px;
  margin-right: 8px;
  margin-top: 4px;
  font-size: 1.1em;
  border-radius: 6px;
  cursor: pointer;
}
footer {
  padding: 10px;
  text-align: center;
  background: #222;
  color: white;
}
footer button {
  margin: 0 5px;
  padding: 10px 20px;
  font-size: 1.2em;
  border-radius: 8px;
}
#volumeRange {
  vertical-align: middle;
  width: 150px;
  margin-left: 10px;
}
</style>
</head>
<body>
<header><h1>FRBB DAB+ Jingles</h1></header>

<main id="categories"></main>

<footer>
  <button id="playBtn">Abspielen</button>
  <button id="stopBtn">Stop</button>
  <label for="volumeRange"></label>
  <input id="volumeRange" type="range" min="0" max="1" step="0.01" value="1">
  
  <audio id="audioPlayer"></audio>
  <audio id="soundbettPlayer"></audio>
</footer>

<script>
const defaultCategories = ['uhr','sender','studio','frequenz','sendereihe','spruch','soundbett'];
const basePath = './milan/';
let status = {}; // enthält on/off/zufall

window.addEventListener('load', loadContent);
document.getElementById('playBtn').addEventListener('click', playAudio);
document.getElementById('stopBtn').addEventListener('click', stopAudio);

async function loadContent() {
  try {
    const res = await fetch('content.cgi');
    if (!res.ok) throw new Error('Fehler beim Laden');
    const profil = (await res.json()).milan;
    const container = document.getElementById('categories');
    container.innerHTML = '';

    const savedOrder = JSON.parse(localStorage.getItem('categoryOrder')) || defaultCategories;
    const savedStatus = JSON.parse(localStorage.getItem('categoryStatus')) || {};
    const savedSelections = JSON.parse(localStorage.getItem('categorySelections')) || {};

    const categories = savedOrder.filter(c => defaultCategories.includes(c));

    categories.forEach(cat => {
      status[cat] = savedStatus[cat] || 'on';
      const div = document.createElement('div');
      div.className = 'category';
      div.setAttribute('draggable', 'true');
      div.dataset.cat = cat;

      const label = createLabel(cat);
      const select = createSelect(cat, profil[cat] || []);

      // --- gespeicherte Auswahl wiederherstellen ---
      if (savedSelections[cat]) {
        select.value = savedSelections[cat];
      }

      // --- zufällige Auswahl bei Spruch und Soundbett ---
      if (['spruch', 'soundbett'].includes(cat)) {
        const opts = [...select.options].map(o => o.value);
        if (opts.length > 0)
          select.value = opts[Math.floor(Math.random() * opts.length)];
      }

      // --- Auswahländerung speichern ---
      if (['sender', 'frequenz', 'studio', 'sendereihe'].includes(cat)) {
        select.addEventListener('change', () => {
          saveCategorySelection(cat, select.value);
        });
      }

      const toggleBtn = createToggleButton(cat, select);
      div.appendChild(label);
      div.appendChild(select);
      div.appendChild(toggleBtn);

      if (cat === 'uhr') {
        const nowBtn = createNowButton(select);
        div.appendChild(nowBtn);
      } else {
        const zufallBtn = createZufallButton(cat, select);
        div.appendChild(zufallBtn);
      }

      // Initialzustand anwenden
      if (status[cat] === 'aus') {
        toggleBtn.textContent = 'Aus';
        select.disabled = true;
      } else if (status[cat] === 'zufall') {
        toggleBtn.textContent = 'An';
      }

      container.appendChild(div);
    });

    enableDragAndDrop(container);
  } catch (e) {
    console.error(e);
    alert('Konnte content.cgi nicht laden');
  }
}

// === Drag & Drop ===
function enableDragAndDrop(container) {
  let dragged = null;
  container.querySelectorAll('.category').forEach(div => {
    div.addEventListener('dragstart', e => {
      dragged = div;
      div.classList.add('dragging');
    });
    div.addEventListener('dragend', e => {
      div.classList.remove('dragging');
      dragged = null;
      saveCategoryOrder(container);
    });
    div.addEventListener('dragover', e => {
      e.preventDefault();
      const after = getDragAfterElement(container, e.clientY);
      if (after == null) container.appendChild(dragged);
      else container.insertBefore(dragged, after);
    });
  });
}
function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll('.category:not(.dragging)')];
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else return closest;
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}
function saveCategoryOrder(container) {
  const order = [...container.querySelectorAll('.category')].map(d => d.dataset.cat);
  localStorage.setItem('categoryOrder', JSON.stringify(order));
}

// === UI-Helfer ===
function createLabel(cat){ const l=document.createElement('label'); l.textContent=cat+':'; return l; }
function createSelect(cat,files){
  const s=document.createElement('select'); s.id=cat;
  files.forEach(f=>{const o=document.createElement('option');o.value=f;o.textContent=f;s.appendChild(o);});
  if(cat==='uhr'){const f=getCurrentHourFile([...s.options].map(o=>o.value));if(f)s.value=f;}
  return s;
}
function createToggleButton(cat,select){
  const b=document.createElement('button');
  b.textContent = 'An';
  b.onclick = () => {
    if (status[cat] === 'on') {
      status[cat] = 'aus';
      b.textContent = 'Aus';
      select.disabled = true;
    } else {
      status[cat] = 'on';
      b.textContent = 'An';
      select.disabled = false;
    }
    saveCategoryStatus();
  };
  return b;
}
function createZufallButton(cat,select){
  const b=document.createElement('button');b.textContent='Zufall';
  b.onclick=()=>{
    status[cat]='zufall';
    select.disabled=false;
    const opts=[...select.options].map(o=>o.value);
    if(opts.length>0)select.value=opts[Math.floor(Math.random()*opts.length)];
    saveCategoryStatus();
  };
  return b;
}
function createNowButton(select){
  const b=document.createElement('button');b.textContent='Jetzt';
  b.onclick=()=>{
    const opts=[...select.options].map(o=>o.value);
    const f=getCurrentHourFile(opts);
    if(f)select.value=f;else alert('Keine Datei für aktuelle Stunde.');
  };
  return b;
}
function getCurrentHourFile(opts){
  const h=(new Date()).getHours();
  const hs=(h<10?'0'+h:h)+'-00.wav';
  return opts.includes(hs)?hs:null;
}

// === Speicherung ===
function saveCategoryStatus() {
  localStorage.setItem('categoryStatus', JSON.stringify(status));
}
function saveCategorySelection(cat, value) {
  const selections = JSON.parse(localStorage.getItem('categorySelections')) || {};
  selections[cat] = value;
  localStorage.setItem('categorySelections', JSON.stringify(selections));
}

// === Datei-Wahl ===
function chooseFile(id){
  const s=document.getElementById(id);
  if(status[id]==='aus')return null;
  if(status[id]==='zufall'){
    const opts=[...s.options].map(o=>o.value);
    if(opts.length===0)return null;
    return opts[Math.floor(Math.random()*opts.length)];
  }
  return s.value;
}

// === Wiedergabe ===
function playAudio(){
  const divs=document.querySelectorAll('.category');
  let sequence=[],soundbettFile=null;

  divs.forEach(div=>{
    const sel=div.querySelector('select');
    if(sel.id==='soundbett'){
      const f=chooseFile(sel.id);
      if(f)soundbettFile=basePath+'soundbett/'+f;
    }else if(sel.id==='uhr'){
      const opts=[...sel.options].map(o=>o.value);
      let f=status[sel.id]==='zufall'
          ? opts[Math.floor(Math.random()*opts.length)]
          : getCurrentHourFile(opts);
      if(f)sequence.push(basePath+'uhr/'+f);
    }else{
      const f=chooseFile(sel.id);
      if(f)sequence.push(basePath+sel.id+'/'+f);
    }
  });

  const audio=document.getElementById('audioPlayer');
  const sb=document.getElementById('soundbettPlayer');

  const vol=parseFloat(document.getElementById('volumeRange').value);
  audio.volume=vol;
  sb.volume=vol*0.1;

  if(soundbettFile){ sb.src=soundbettFile; sb.loop=false; sb.play(); }
  else { sb.pause(); sb.src=''; }

  if(sequence.length===0)return;
  let idx=0;
  audio.src=sequence[idx];
  audio.play();

  audio.onended=function(){
    idx++;
    if(idx<sequence.length){
      audio.src=sequence[idx];
      audio.play();
    } else {
      // === Soundbett am Ende langsam ausblenden ===
      const fadeOut = setInterval(() => {
        if (sb.volume > 0.01) {
          sb.volume -= 0.01;
        } else {
          clearInterval(fadeOut);
          sb.pause();
          sb.src = '';
          sb.volume = vol * 0.1; // Reset für nächste Wiedergabe
        }
      }, 100); // alle 100 ms Lautstärke etwas senken (~5 Sekunden Fade)
      audio.onended=null;
    }
  };
}

function stopAudio(){
  const audio=document.getElementById('audioPlayer');
  const sb=document.getElementById('soundbettPlayer');
  audio.pause(); audio.currentTime=0; audio.src='';
  sb.pause(); sb.currentTime=0; sb.src='';
  audio.onended=null;
}

// === Lautstärkeregelung ===
const volumeRange=document.getElementById('volumeRange');
const audioPlayer=document.getElementById('audioPlayer');
const soundbettPlayer=document.getElementById('soundbettPlayer');

volumeRange.addEventListener('input',()=>{
  const vol=parseFloat(volumeRange.value);
  audioPlayer.volume=vol;
  soundbettPlayer.volume=vol*0.1;
});
</script>
</body>
</html>

